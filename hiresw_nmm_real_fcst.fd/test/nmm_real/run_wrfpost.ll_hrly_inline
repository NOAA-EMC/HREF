#!/bin/ksh
#
#@ output = out.post
#@ error = err.post
#@ job_type = parallel
#@ class = dev
#@ arguments = aknmm 00
#@ total_tasks = 5
#@ blocking=unlimited
#@ wall_clock_limit = 00:39:00
#@ network.MPI = csss,shared,us
#@ queue
#
#

DOM=${1}
CYC=${2}
######
INCR=01
######

EXE=wrfpost.x_223x501


OUTTYP=binary
MODEL=NMM

filedir=/gpfstmp/wx20py/tmp_wrfreal_${DOM}

bindir=/emc2/wx20py/wrf_nmm/WRFV1/test/nmm_real

mkdir -p /gpfstmp/wx20py/wrfpost_nmmtest_$DOM
cd /gpfstmp/wx20py/wrfpost_nmmtest_$DOM
rm -rf /gpfstmp/wx20py/wrfpost_nmmtest_${DOM}/*

cp $filedir/t${CYC}z .

YYYY=`cat t${CYC}z | cut -c7-10`
MM=`cat t${CYC}z | cut -c11-12`
DD=`cat t${CYC}z | cut -c13-14`

startd=$YYYY$MM$DD
dirout=/emc2/wx20py/wrf_nmm/${DOM}/${startd}${CYC}

# mkdir -p $dirout

STARTDATE=${YYYY}-${MM}-${DD}T${CYC}:00:00

datetmp=`$bindir/tomorrow $YYYY$MM$DD`
endtime=`$bindir/tomorrow $datetmp`


YYYY=`echo $endtime | cut -c1-4`
MM=`echo $endtime | cut -c5-6`
DD=`echo $endtime | cut -c7-8`
FINALDATE=${YYYY}-${MM}-${DD}T${CYC}:00:00

export tmmark=tm00

wyr=`echo $STARTDATE | cut -c1-4`
wmn=`echo $STARTDATE | cut -c6-7`
wdy=`echo $STARTDATE | cut -c9-10`
whr=`echo $STARTDATE | cut -c12-13`

eyr=`echo $FINALDATE | cut -c1-4`
emn=`echo $FINALDATE | cut -c6-7`
edy=`echo $FINALDATE | cut -c9-10`
ehr=`echo $FINALDATE | cut -c12-13`

echo $STARTDATE
echo $FINALDATE

edate=$eyr$emn$edy$ehr

wdate=$wyr$wmn$wdy$whr

timeform=$STARTDATE

# cp /emc2/wx20py/wrf_nmm/WRFV1/test/nmm_real/wrf_cntrl_central08.all ./wrf_cntrl.parm
cp /emc2/wx20py/wrf_nmm/WRFV1/test/nmm_real/hiresw_wrfnmm_cntrl_expand.parm ./wrf_cntrl.parm

echo $wdate $edate

while [ $wdate -le $edate ]
do
whr=`expr $whr + $INCR`

if [ $whr -ge 24 ]
then
whr=`expr $whr - 24`
# wdy=`expr $wdy + 1`

date=$wyr$wmn$wdy

echo "old date" $date
date=`$bindir/tomorrow $wyr$wmn$wdy`

wyr=`echo $date | cut -c1-4`
wmn=`echo $date | cut -c5-6`
wdy=`echo $date | cut -c7-8`
fi

if [ $whr -lt 10 ]
then
whr=0$whr
fi

echo "working on " $timeform

while [ ! -s $filedir/wrfout_d01_${timeform} ]
do
echo "waiting for desired file" wrfout_d01_${timeform}
sleep 55
done

### make sure it is fully written
#
# better idea would be to wait until next in sequence existed...
#  then would be 100% sure that preceding file was complete
#

sleep 120


echo "making itag, here timeform is: " $timeform

cat > itag <<EOF
$filedir/wrfout_d01_${timeform}
$OUTTYP
$timeform
$MODEL
EOF

# cat > itag <<EOF
# $filedir/wrfout_0824_tb_f00
# $OUTTYP
# $timeform
# $MODEL
# EOF

#-----------------------------------------------------------------------
#   Run etapost.

ln -sf wrf_cntrl.parm fort.14

echo "executing the post"
/emc2/wx20py/wrf_nmm/unified_wrfpost_hcnew_nonet/$EXE < itag > outpost.$wdate
echo "done executing the post"

err=$?

echo "exit code= " $err
echo "just ran wrfpost with this in itag:"

cat itag
echo "done"

wdate=$wyr$wmn$wdy$whr

timeform=${wyr}"-"${wmn}"-"${wdy}"T"${whr}":00:00"
echo "wdate at end " $wdate
echo "edate at end " $edate
done

# rcp WRFPRS*.tm00  hanfs2:${dirout}/

exit
